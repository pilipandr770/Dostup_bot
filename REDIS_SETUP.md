# Интеграция Redis в Dostup Bot

## Введение
Для решения проблемы с множественными экземплярами бота на сервере, мы добавили систему распределенных блокировок через Redis. Это обеспечивает дополнительный уровень защиты от запуска нескольких экземпляров бота одновременно.

## Как работает Redis-блокировка

Redis-блокировка использует механизм атомарных операций в Redis для обеспечения того, чтобы только один экземпляр бота мог работать одновременно:

1. Бот пытается создать уникальный ключ в Redis с ограниченным временем жизни
2. Если ключ успешно создан, бот получает "блокировку" и продолжает работу
3. Отдельный поток обновляет время жизни ключа, чтобы блокировка не истекла пока бот работает
4. При завершении работы бота ключ удаляется, позволяя другим экземплярам получить блокировку

## Настройка Redis

### Локальный Redis для разработки

1. Установите Redis на вашу локальную машину
2. Запустите Redis сервер
3. Создайте файл `.env` в корне проекта со следующим содержимым:
   ```
   REDIS_URL=redis://localhost:6379/0
   ```

### Облачный Redis для продакшена

Для продакшен-среды рекомендуется использовать облачный Redis-сервис:

1. Зарегистрируйтесь на одном из облачных провайдеров Redis:
   - [Upstash](https://upstash.com/) (есть бесплатный план)
   - [Redis Labs](https://redislabs.com/) (есть бесплатный план)
   - [AWS ElastiCache](https://aws.amazon.com/elasticache/) (платный)

2. Создайте Redis базу данных и получите URL для подключения

3. Добавьте URL в переменные окружения вашего сервера или в файл `.env`:
   ```
   REDIS_URL=redis://username:password@your-redis-host:port/0
   ```

## Проверка работы Redis-блокировки

Вы можете проверить работу Redis-блокировки, запустив следующую команду:

```bash
python redis_lock.py
```

Это запустит тестовый скрипт, который попытается получить Redis-блокировку и будет удерживать её до нажатия Ctrl+C.

## Отладка Redis-блокировки

Если возникают проблемы с Redis-блокировкой, проверьте следующее:

1. Redis сервер запущен и доступен
2. URL для подключения к Redis правильный
3. В логах бота нет ошибок, связанных с Redis

Дополнительные команды для отладки:

```bash
# Проверить подключение к Redis
redis-cli -u $REDIS_URL ping

# Проверить наличие ключа блокировки
redis-cli -u $REDIS_URL get dostup_bot_lock

# Удалить ключ блокировки вручную (если бот завершился некорректно)
redis-cli -u $REDIS_URL del dostup_bot_lock
```

## Реализация в коде

Система Redis-блокировки реализована в файле `redis_lock.py` и интегрирована в основной код бота.

При запуске бот пытается:
1. Получить Redis-блокировку (если настроен REDIS_URL)
2. Получить файловую блокировку (как резервный вариант)

Это обеспечивает надежную защиту от множественных экземпляров бота.
